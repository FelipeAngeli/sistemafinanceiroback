# Deploy no Render

Este documento explica como fazer deploy da aplicação na plataforma Render.

## Pré-requisitos

- Conta no [Render](https://render.com)
- Repositório Git (GitHub, GitLab ou Bitbucket) com o código
- PostgreSQL (pode ser criado via Render ou externo)

## Opção 1: Deploy via Dashboard (Recomendado)

### Passo 1: Criar Web Service

1. Acesse o [Dashboard do Render](https://dashboard.render.com)
2. Clique em **"New +"** → **"Web Service"**
3. Conecte seu repositório Git
4. Configure o serviço:
   - **Name**: `sistemafinanceiroback`
   - **Region**: Escolha a região mais próxima (ex: `Sao Paulo`)
   - **Branch**: `main` (ou sua branch principal)
   - **Root Directory**: Deixe vazio (raiz do projeto)
   - **Runtime**: `Python 3`
   - **Build Command**: `pip install -r requirements.txt`
   - **Start Command**: `uvicorn app.main:app --host 0.0.0.0 --port $PORT`
   - **Plan**: Escolha o plano (Starter é suficiente para começar)

### Passo 2: Configurar Variáveis de Ambiente

No painel do serviço, vá em **"Environment"** e adicione:

```env
APP_ENV=production
DEBUG=false
LOG_LEVEL=INFO
APP_NAME=PsychologistSystem
```

### Passo 3: Criar PostgreSQL Database

1. No Dashboard, clique em **"New +"** → **"PostgreSQL"**
2. Configure:
   - **Name**: `sistemafinanceiro-db`
   - **Database**: `psychologist`
   - **User**: `psychologist_user`
   - **Region**: Mesma região do Web Service
   - **Plan**: Starter (ou superior)
3. Após criar, vá em **"Connections"** → **"Internal Database URL"**
4. Copie a connection string e adicione como variável de ambiente no Web Service:
   - **Key**: `DATABASE_URL`
   - **Value**: Cole a connection string
   - **Importante**: Render fornece URLs no formato `postgresql://`, mas precisamos `postgresql+asyncpg://` para SQLAlchemy async

   **Converter a URL:**
   ```
   De: postgresql://user:pass@host:5432/dbname
   Para: postgresql+asyncpg://user:pass@host:5432/dbname
   ```

### Passo 4: Configurar CORS (se necessário)

Se você tem um frontend rodando em outro domínio, adicione:

```env
CORS_ORIGINS=["https://seu-frontend.com"]
```

Ou múltiplos domínios:
```env
CORS_ORIGINS=["https://app.com","https://www.app.com"]
```

### Passo 5: Deploy

1. Clique em **"Manual Deploy"** → **"Deploy latest commit"**
2. Aguarde o build e deploy (geralmente 2-5 minutos)
3. Verifique os logs para garantir que tudo está funcionando
4. Acesse `https://seu-servico.onrender.com/health` para testar

---

## Opção 2: Deploy via render.yaml (Infraestrutura como Código)

Se você prefere versionar a configuração, use o arquivo `render.yaml` na raiz do projeto.

### Passo 1: Ajustar render.yaml

Edite `render.yaml` e descomente/ajuste conforme necessário:

```yaml
services:
  - type: web
    name: sistemafinanceiroback
    # ... configurações
    database:
      - key: DATABASE_URL
        fromDatabase:
          name: sistemafinanceiro-db
          property: connectionString

databases:
  - name: sistemafinanceiro-db
    # ... configurações
```

**Importante**: A connection string do Render vem como `postgresql://`, mas precisamos converter para `postgresql+asyncpg://`. Você pode:

1. **Opção A**: Criar um script de build que converte a URL
2. **Opção B**: Configurar manualmente a variável `DATABASE_URL` no dashboard após criar o banco

### Passo 2: Deploy via Blueprint

1. No Dashboard, clique em **"New +"** → **"Blueprint"**
2. Conecte o repositório
3. Render detectará automaticamente o `render.yaml`
4. Revise e confirme o deploy

---

## Configuração da Connection String

O Render fornece a connection string no formato:
```
postgresql://user:password@host:5432/dbname
```

Mas o SQLAlchemy async precisa:
```
postgresql+asyncpg://user:password@host:5432/dbname
```

### Solução Automática

Crie um script `scripts/fix_database_url.py`:

```python
import os
import sys

database_url = os.environ.get("DATABASE_URL", "")
if database_url.startswith("postgresql://"):
    database_url = database_url.replace("postgresql://", "postgresql+asyncpg://", 1)
    os.environ["DATABASE_URL"] = database_url
```

E ajuste o `startCommand` no render.yaml:
```yaml
startCommand: python scripts/fix_database_url.py && uvicorn app.main:app --host 0.0.0.0 --port $PORT
```

Ou ajuste o `config.py` para fazer a conversão automaticamente:

```python
@field_validator("database_url", mode="before")
@classmethod
def fix_postgres_url(cls, v: str) -> str:
    """Converte postgresql:// para postgresql+asyncpg:// se necessário."""
    if isinstance(v, str) and v.startswith("postgresql://") and "+asyncpg" not in v:
        return v.replace("postgresql://", "postgresql+asyncpg://", 1)
    return v
```

---

## Variáveis de Ambiente Recomendadas

```env
# Aplicação
APP_ENV=production
DEBUG=false
LOG_LEVEL=INFO
APP_NAME=PsychologistSystem

# Banco de Dados (configurado automaticamente pelo Render PostgreSQL)
DATABASE_URL=postgresql+asyncpg://user:pass@host:5432/dbname

# CORS (ajustar com seus domínios)
CORS_ORIGINS=["https://seu-frontend.com"]
```

---

## Health Check

O Render usa automaticamente o endpoint `/health` para verificar se o serviço está rodando.

Certifique-se de que o endpoint está funcionando:
```bash
curl https://seu-servico.onrender.com/health
```

---

## Troubleshooting

### Erro: "Connection refused" ou timeout

- Verifique se o `startCommand` está usando `$PORT`
- Verifique os logs no dashboard do Render
- Confirme que o serviço está rodando (status "Live")

### Erro: "Database connection failed"

- Verifique se a `DATABASE_URL` está configurada corretamente
- Confirme que a URL está no formato `postgresql+asyncpg://`
- Verifique se o PostgreSQL está na mesma região do Web Service
- Confirme que o banco está acessível (não bloqueado por firewall)

### Erro: "Module not found: asyncpg"

- Verifique se `asyncpg>=0.29.0` está no `requirements.txt`
- Confirme que o build instalou todas as dependências

### Build falha

- Verifique os logs de build no dashboard
- Confirme que o Python 3.11+ está sendo usado
- Verifique se todas as dependências estão no `requirements.txt`

### Aplicação reinicia constantemente

- Verifique os logs para erros de runtime
- Confirme que o health check está retornando 200 OK
- Verifique se há erros de conexão com o banco

---

## Monitoramento

- **Logs**: Acesse "Logs" no dashboard do serviço
- **Metrics**: Render fornece métricas básicas (CPU, memória, requisições)
- **Alerts**: Configure alertas para downtime ou erros

---

## Escalabilidade

- **Auto-scaling**: Render escala automaticamente baseado em carga
- **Plans**: Upgrade para Standard ou Pro para mais recursos
- **Database**: Upgrade o plano do PostgreSQL conforme necessário

---

## Custos

- **Starter Plan**: Gratuito (com limitações)
- **Standard Plan**: ~$7/mês por serviço
- **PostgreSQL Starter**: Gratuito (com limitações)
- **PostgreSQL Standard**: ~$7/mês

Consulte [Render Pricing](https://render.com/pricing) para detalhes atualizados.

---

## Próximos Passos

1. ✅ Configurar CI/CD (deploy automático a cada push)
2. ✅ Configurar domínio customizado
3. ✅ Configurar SSL/TLS (automático no Render)
4. ✅ Configurar backups do PostgreSQL
5. ✅ Configurar monitoramento e alertas
