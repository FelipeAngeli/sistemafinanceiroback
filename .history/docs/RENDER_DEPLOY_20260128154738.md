# Deploy no Render

Este documento explica como fazer deploy da aplica√ß√£o na plataforma Render.

## Pr√©-requisitos

- Conta no [Render](https://render.com)
- Reposit√≥rio Git (GitHub, GitLab ou Bitbucket) com o c√≥digo
- PostgreSQL (pode ser criado via Render ou externo)

> üìñ **Documenta√ß√£o Oficial**: Consulte a [documenta√ß√£o oficial do Render sobre Web Services](https://render.com/docs/web-services) para mais detalhes.

## Op√ß√£o 1: Deploy via Dashboard (Recomendado)

### Passo 1: Criar Web Service

1. Acesse o [Dashboard do Render](https://dashboard.render.com)
2. Clique em **"New +"** ‚Üí **"Web Service"**
3. Conecte seu reposit√≥rio Git
4. Configure o servi√ßo:
   - **Name**: `sistemafinanceiroback`
   - **Region**: Escolha a regi√£o mais pr√≥xima:
     - `oregon` (US West)
     - `ohio` (US East)
     - `frankfurt` (EU)
     - `singapore` (Asia)
     - `virginia` (US East)
   - **Branch**: `main` (ou sua branch principal)
   - **Root Directory**: Deixe vazio (raiz do projeto)
   - **Runtime**: `Python 3`
   - **Build Command**: `pip install -r requirements.txt`
   - **Start Command**: `uvicorn app.main:app --host 0.0.0.0 --port $PORT`
   - **Plan**: Escolha o plano (Starter √© suficiente para come√ßar)
   - **Health Check Path**: `/health` (opcional, mas recomendado)

> ‚ö†Ô∏è **Importante**: 
> - O Render define `PORT` automaticamente (padr√£o: `10000`)
> - O servi√ßo **deve** fazer bind em `0.0.0.0` (n√£o `127.0.0.1` ou `localhost`)
> - O Render pode detectar a porta automaticamente, mas √© recomendado usar `$PORT` explicitamente

### Passo 2: Configurar Vari√°veis de Ambiente

No painel do servi√ßo, v√° em **"Environment"** e adicione:

```env
APP_ENV=production
DEBUG=false
LOG_LEVEL=INFO
APP_NAME=PsychologistSystem
```

### Passo 3: Criar PostgreSQL Database

1. No Dashboard, clique em **"New +"** ‚Üí **"PostgreSQL"**
2. Configure:
   - **Name**: `sistemafinanceiro-db`
   - **Database**: `psychologist`
   - **User**: `psychologist_user`
   - **Region**: Mesma regi√£o do Web Service (oregon, ohio, frankfurt, singapore, virginia)
   - **Plan**: Starter (ou superior)
3. Ap√≥s criar, v√° em **"Connections"** ‚Üí **"Internal Database URL"**
4. Copie a connection string e adicione como vari√°vel de ambiente no Web Service:
   - **Key**: `DATABASE_URL`
   - **Value**: Cole a connection string
   - **Importante**: Render fornece URLs no formato `postgresql://`, mas precisamos `postgresql+asyncpg://` para SQLAlchemy async

   **Converter a URL:**
   ```
   De: postgresql://user:pass@host:5432/dbname
   Para: postgresql+asyncpg://user:pass@host:5432/dbname
   ```

### Passo 4: Configurar CORS (se necess√°rio)

Se voc√™ tem um frontend rodando em outro dom√≠nio, adicione:

```env
CORS_ORIGINS=["https://seu-frontend.com"]
```

Ou m√∫ltiplos dom√≠nios:
```env
CORS_ORIGINS=["https://app.com","https://www.app.com"]
```

### Passo 5: Deploy

1. Clique em **"Manual Deploy"** ‚Üí **"Deploy latest commit"**
2. Aguarde o build e deploy (geralmente 2-5 minutos)
3. Verifique os logs para garantir que tudo est√° funcionando
4. Acesse `https://seu-servico.onrender.com/health` para testar

---

## Op√ß√£o 2: Deploy via render.yaml (Infraestrutura como C√≥digo)

Se voc√™ prefere versionar a configura√ß√£o, use o arquivo `render.yaml` na raiz do projeto.

### Passo 1: Ajustar render.yaml

Edite `render.yaml` e descomente/ajuste conforme necess√°rio:

```yaml
services:
  - type: web
    name: sistemafinanceiroback
    # ... configura√ß√µes
    database:
      - key: DATABASE_URL
        fromDatabase:
          name: sistemafinanceiro-db
          property: connectionString

databases:
  - name: sistemafinanceiro-db
    # ... configura√ß√µes
```

**Importante**: A connection string do Render vem como `postgresql://`, mas precisamos converter para `postgresql+asyncpg://`. Voc√™ pode:

1. **Op√ß√£o A**: Criar um script de build que converte a URL
2. **Op√ß√£o B**: Configurar manualmente a vari√°vel `DATABASE_URL` no dashboard ap√≥s criar o banco

### Passo 2: Deploy via Blueprint

1. No Dashboard, clique em **"New +"** ‚Üí **"Blueprint"**
2. Conecte o reposit√≥rio
3. Render detectar√° automaticamente o `render.yaml`
4. Revise e confirme o deploy

---

## Configura√ß√£o da Connection String

O Render fornece a connection string no formato:
```
postgresql://user:password@host:5432/dbname
```

Mas o SQLAlchemy async precisa:
```
postgresql+asyncpg://user:password@host:5432/dbname
```

### Solu√ß√£o Autom√°tica

Crie um script `scripts/fix_database_url.py`:

```python
import os
import sys

database_url = os.environ.get("DATABASE_URL", "")
if database_url.startswith("postgresql://"):
    database_url = database_url.replace("postgresql://", "postgresql+asyncpg://", 1)
    os.environ["DATABASE_URL"] = database_url
```

E ajuste o `startCommand` no render.yaml:
```yaml
startCommand: python scripts/fix_database_url.py && uvicorn app.main:app --host 0.0.0.0 --port $PORT
```

Ou ajuste o `config.py` para fazer a convers√£o automaticamente:

```python
@field_validator("database_url", mode="before")
@classmethod
def fix_postgres_url(cls, v: str) -> str:
    """Converte postgresql:// para postgresql+asyncpg:// se necess√°rio."""
    if isinstance(v, str) and v.startswith("postgresql://") and "+asyncpg" not in v:
        return v.replace("postgresql://", "postgresql+asyncpg://", 1)
    return v
```

---

## Vari√°veis de Ambiente Recomendadas

```env
# Aplica√ß√£o
APP_ENV=production
DEBUG=false
LOG_LEVEL=INFO
APP_NAME=PsychologistSystem

# Banco de Dados (configurado automaticamente pelo Render PostgreSQL)
DATABASE_URL=postgresql+asyncpg://user:pass@host:5432/dbname

# CORS (ajustar com seus dom√≠nios)
CORS_ORIGINS=["https://seu-frontend.com"]
```

---

## Health Check

O Render usa o endpoint configurado em **Health Check Path** (recomendado: `/health`) para verificar se o servi√ßo est√° rodando.

**Configura√ß√£o:**
- No dashboard do servi√ßo, v√° em **Settings** ‚Üí **Health Check Path**
- Configure: `/health`
- O Render verifica este endpoint periodicamente para garantir que o servi√ßo est√° saud√°vel

**Teste manual:**
```bash
curl https://seu-servico.onrender.com/health
```

**Port Binding:**
- O Render espera que o servi√ßo fa√ßa bind em `0.0.0.0` (n√£o `127.0.0.1`)
- Use `$PORT` no start command (padr√£o: `10000`)
- Portas reservadas que n√£o podem ser usadas: `18012`, `18013`, `19099`

---

## Troubleshooting

### Erro: "Connection refused" ou timeout

- Verifique se o `startCommand` est√° usando `$PORT` e bind em `0.0.0.0`
- Verifique os logs no dashboard do Render
- Confirme que o servi√ßo est√° rodando (status "Live")
- Certifique-se de que o uvicorn est√° fazendo bind em `0.0.0.0` (n√£o `127.0.0.1`)

### Erro: "Database connection failed"

- Verifique se a `DATABASE_URL` est√° configurada corretamente
- Confirme que a URL est√° no formato `postgresql+asyncpg://`
- Verifique se o PostgreSQL est√° na mesma regi√£o do Web Service
- Confirme que o banco est√° acess√≠vel (n√£o bloqueado por firewall)

### Erro: "Module not found: asyncpg"

- Verifique se `asyncpg>=0.29.0` est√° no `requirements.txt`
- Confirme que o build instalou todas as depend√™ncias

### Build falha

- Verifique os logs de build no dashboard
- Confirme que o Python 3.11+ est√° sendo usado
- Verifique se todas as depend√™ncias est√£o no `requirements.txt`

### Aplica√ß√£o reinicia constantemente

- Verifique os logs para erros de runtime
- Confirme que o health check est√° retornando 200 OK
- Verifique se h√° erros de conex√£o com o banco

---

## Monitoramento

- **Logs**: Acesse "Logs" no dashboard do servi√ßo
- **Metrics**: Render fornece m√©tricas b√°sicas (CPU, mem√≥ria, requisi√ß√µes)
- **Alerts**: Configure alertas para downtime ou erros

---

## Escalabilidade

- **Auto-scaling**: Render escala automaticamente baseado em carga
- **Plans**: Upgrade para Standard ou Pro para mais recursos
- **Database**: Upgrade o plano do PostgreSQL conforme necess√°rio

---

## Custos

- **Starter Plan**: Gratuito (com limita√ß√µes)
- **Standard Plan**: ~$7/m√™s por servi√ßo
- **PostgreSQL Starter**: Gratuito (com limita√ß√µes)
- **PostgreSQL Standard**: ~$7/m√™s

Consulte [Render Pricing](https://render.com/pricing) para detalhes atualizados.

---

## Recursos Adicionais do Render

O Render oferece v√°rios recursos √∫teis para produ√ß√£o:

### Recursos Inclu√≠dos

- ‚úÖ **Deploy Autom√°tico**: Deploy autom√°tico a cada push no branch configurado
- ‚úÖ **SSL/TLS Gratuito**: Certificados SSL gerenciados automaticamente
- ‚úÖ **Dom√≠nios Customizados**: Adicione seu pr√≥prio dom√≠nio (ex: `api.seudominio.com`)
- ‚úÖ **Zero-Downtime Deploys**: Deploys sem interrup√ß√£o do servi√ßo
- ‚úÖ **Rollback Instant√¢neo**: Reverta para vers√µes anteriores com um clique
- ‚úÖ **Health Checks**: Monitoramento autom√°tico da sa√∫de do servi√ßo
- ‚úÖ **Logs em Tempo Real**: Visualize logs diretamente no dashboard
- ‚úÖ **M√©tricas**: CPU, mem√≥ria e requisi√ß√µes em tempo real
- ‚úÖ **WebSockets**: Suporte nativo para conex√µes WebSocket
- ‚úÖ **DDoS Protection**: Prote√ß√£o contra ataques DDoS inclu√≠da
- ‚úÖ **HTTP/2**: Suporte autom√°tico para HTTP/2
- ‚úÖ **Brotli Compression**: Compress√£o autom√°tica de respostas

### Recursos Avan√ßados

- **Service Previews**: Ambientes de preview para cada PR
- **Private Network**: Comunica√ß√£o segura entre servi√ßos Render
- **Persistent Disks**: Armazenamento persistente para arquivos
- **Edge Caching**: Cache de assets est√°ticos na edge
- **Scaling Manual/Autom√°tico**: Escale horizontalmente conforme necess√°rio
- **Maintenance Mode**: Coloque o servi√ßo em modo manuten√ß√£o

## Pr√≥ximos Passos

1. ‚úÖ Configurar CI/CD (deploy autom√°tico a cada push) - **J√° configurado automaticamente**
2. ‚úÖ Configurar dom√≠nio customizado (Settings ‚Üí Custom Domains)
3. ‚úÖ Configurar SSL/TLS (autom√°tico no Render)
4. ‚úÖ Configurar backups do PostgreSQL (Settings ‚Üí Backups)
5. ‚úÖ Configurar monitoramento e alertas (Settings ‚Üí Notifications)
6. ‚úÖ Configurar Service Previews para PRs (opcional)
7. ‚úÖ Configurar scaling autom√°tico (Settings ‚Üí Scaling)
